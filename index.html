<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carteira B3 – Simples (HTML + LocalStorage)</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --muted: #1f2937;     /* gray-800 */
      --soft: #0b1220;      /* custom */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #22c55e;    /* green-500 */
      --accent-2: #60a5fa;  /* blue-400 */
      --danger: #ef4444;    /* red-500 */
      --warning: #f59e0b;   /* amber-500 */
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -10%, #1e293b 0%, var(--bg) 40%),
                  radial-gradient(900px 700px at -10% -20%, #172554 0%, var(--bg) 45%),
                  var(--bg);
      color: var(--text);
    }
    header {
      padding: 28px 20px; position: sticky; top: 0; z-index: 5; backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55) 60%, rgba(15,23,42,0));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 0 14px; }
    .title { display:flex; align-items:center; gap:14px; }
    .title h1 { margin:0; font-size: 28px; letter-spacing:.3px; }
    .badge { font-size: 12px; padding: 5px 10px; border-radius: 999px; background:rgba(96,165,250,.15); color:#93c5fd; border:1px solid rgba(147,197,253,.25) }

    .grid { display:grid; gap:18px; grid-template-columns: 1.25fr .75fr; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg, rgba(17,24,39,.95), rgba(17,24,39,.85)); border: 1px solid rgba(255,255,255,.08); box-shadow: var(--shadow); border-radius: var(--radius); }
    .card .hd { padding: 16px 18px; border-bottom:1px solid rgba(255,255,255,.06); font-weight: 600; opacity:.95 }
    .card .bd { padding: 18px; }

    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .row + .row { margin-top: 12px; }
    label { font-size: 12px; opacity:.85; display:block; margin-bottom: 6px; }
    input, select { width: 100%; background: #0b1020; color: var(--text); padding: 12px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); outline:none; }
    input::placeholder { color: #9ca3af; }

    .actions { display:flex; gap:10px; flex-wrap: wrap; }
    .btn { border:1px solid rgba(255,255,255,.12); background:#0b1020; color: var(--text); padding: 11px 14px; border-radius: 12px; cursor:pointer; transition:.2s; }
    .btn:hover { transform: translateY(-1px); border-color: rgba(255,255,255,.25); }
    .btn.primary { background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.18)); border:1px solid rgba(34,197,94,.45); color:#bbf7d0; }
    .btn.sec { background: linear-gradient(180deg, rgba(96,165,250,.2), rgba(96,165,250,.12)); border:1px solid rgba(96,165,250,.35); color:#dbeafe; }
    .btn.warn { background: linear-gradient(180deg, rgba(245,158,11,.2), rgba(245,158,11,.12)); border:1px solid rgba(245,158,11,.35); color:#fde68a; }
    .btn.danger { background: linear-gradient(180deg, rgba(239,68,68,.2), rgba(239,68,68,.12)); border:1px solid rgba(239,68,68,.35); color:#fecaca; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px 10px; border-bottom:1px dashed rgba(255,255,255,.08); }
    th { font-size: 12px; font-weight:600; opacity:.8; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    tfoot td { font-weight: 700; padding-top: 12px; border-top:1px solid rgba(255,255,255,.12); }

    .pill { padding: 4px 8px; border-radius:999px; font-size: 12px; border:1px solid rgba(255,255,255,.12); opacity:.9 }

    .right { text-align:right; }
    .muted { opacity:.7; }
    .green { color: #86efac; }
    .red { color: #fca5a5; }
    .nowrap { white-space: nowrap; }

    .hint { font-size:12px; opacity:.75; }
    .flex { display:flex; gap:12px; align-items:center; }
    .grow { flex:1 }

    .footer { text-align:center; opacity:.6; font-size:12px; padding: 24px 12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 3v18h18" stroke="#93c5fd" stroke-width="1.6"/>
        <path d="M7 15l3-3 3 2 4-6" stroke="#86efac" stroke-width="1.6"/>
      </svg>
      <h1>Carteira B3 – Estática</h1>
      <span class="badge">HTML + JS + LocalStorage</span>
    </div>
  </header>

  <main class="wrap" style="padding: 18px 0 34px">
    <div class="grid">
      <!-- FORM CARD -->
      <section class="card">
        <div class="hd">Adicionar ativo</div>
        <div class="bd">
          <form id="formAtivo">
            <div class="row">
              <div class="col" style="grid-column: span 4;">
                <label for="ticker">Ticker (B3)</label>
                <input id="ticker" name="ticker" placeholder="ex: PETR4, VALE3, MXRF11" required />
              </div>
              <div class="col" style="grid-column: span 3;">
                <label for="tipo">Tipo</label>
                <select id="tipo" name="tipo">
                  <option value="Ação">Ação</option>
                  <option value="FII">FII</option>
                  <option value="ETF">ETF</option>
                  <option value="BDR">BDR</option>
                  <option value="Outros">Outros</option>
                </select>
              </div>
              <div class="col" style="grid-column: span 2;">
                <label for="quantidade">Quantidade</label>
                <input id="quantidade" name="quantidade" type="number" min="1" step="1" placeholder="ex: 10" required />
              </div>
              <div class="col" style="grid-column: span 3;">
                <label for="preco">Preço (R$)</label>
                <input id="preco" name="preco" inputmode="decimal" placeholder="ex: 28,75" required />
              </div>
            </div>
            <div class="row">
              <div class="col" style="grid-column: span 3;">
                <label for="corretagem">Taxas (R$)</label>
                <input id="corretagem" name="corretagem" inputmode="decimal" placeholder="0,00" />
              </div>
              <div class="col" style="grid-column: span 3;">
                <label for="data">Data</label>
                <input id="data" name="data" type="date" />
              </div>
              <div class="col" style="grid-column: span 6; display:flex; align-items:flex-end; justify-content:flex-end">
                <div class="actions">
                  <button class="btn" type="button" id="limpar">Limpar</button>
                  <button class="btn primary" type="submit">Adicionar</button>
                </div>
              </div>
            </div>
            <p class="hint" style="margin-top:10px">Dica: use vírgula como separador decimal (ex: 10,50). O preço é o valor por cota/ação.</p>
          </form>
        </div>
      </section>

      <!-- SUMMARY CARD -->
      <section class="card">
        <div class="hd">Resumo</div>
        <div class="bd">
          <div class="row">
            <div class="col" style="grid-column: span 6;">
              <div class="muted">Investido</div>
              <div id="sumInvestido" style="font-size: 22px; font-weight:700; margin-top:6px">R$ 0,00</div>
            </div>
            <div class="col" style="grid-column: span 6;">
              <div class="muted">Valor Atual (manual)</div>
              <div id="sumAtual" style="font-size: 22px; font-weight:700; margin-top:6px">R$ 0,00</div>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <div class="col" style="grid-column: span 6;">
              <div class="muted">Resultado</div>
              <div id="sumResultado" style="font-size: 20px; font-weight:700; margin-top:6px">R$ 0,00 <span class="muted">(0,00%)</span></div>
            </div>
            <div class="col" style="grid-column: span 6; display:flex; align-items:end; justify-content:flex-end">
              <div class="actions">
                <button class="btn sec" id="exportarCsv">Exportar CSV</button>
                <label class="btn warn" for="importCsv">Importar CSV</label>
                <input id="importCsv" type="file" accept=".csv" style="display:none" />
                <button class="btn danger" id="apagarTudo">Apagar tudo</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- TABLE CARD -->
    <section class="card" style="margin-top:18px">
      <div class="hd">Posições</div>
      <div class="bd">
        <div class="hint" style="margin-bottom:10px">Dê duplo clique na coluna <b>Preço Atual</b> para editar manualmente e simular cenários.</div>
        <div style="overflow:auto">
          <table id="tabela">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Tipo</th>
                <th class="right">Qtde</th>
                <th class="right">Preço Médio</th>
                <th class="right">Investido</th>
                <th class="right">Preço Atual</th>
                <th class="right">Valor Atual</th>
                <th class="right">Resultado</th>
                <th class="right">% </th>
                <th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="corpoTabela">
              <!-- linhas via JS -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="10" class="muted">Armazenamento local do navegador (LocalStorage). Nenhum dado sai do seu dispositivo.</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">Feito para estudos. Não é recomendação de investimento.</div>

<script>
  // ===== Utilidades de número e moeda (pt-BR) =====
  const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  const fmtNum = new Intl.NumberFormat('pt-BR', { maximumFractionDigits: 2 });
  function parseBRL(str) {
    if (str == null || str === '') return 0;
    // aceita 10,50 ou 10.50
    return Number(String(str).replace(/\./g,'').replace(',', '.')) || 0;
  }
  function toBRL(n) { return fmtBRL.format(n || 0); }
  function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }

  // ===== Estado / Storage =====
  const STORAGE_KEY = 'carteira_b3_v1';
  let carteira = load(); // array de posições
  // posição: { id, ticker, tipo, quantidade, precoMedio, investido, precoAtual }

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(carteira)); }
  function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e){ return []; } }

  // ===== DOM =====
  const form = document.getElementById('formAtivo');
  const corpo = document.getElementById('corpoTabela');
  const sumInvestido = document.getElementById('sumInvestido');
  const sumAtual = document.getElementById('sumAtual');
  const sumResultado = document.getElementById('sumResultado');

  document.getElementById('limpar').addEventListener('click', () => form.reset());
  document.getElementById('apagarTudo').addEventListener('click', () => {
    if(confirm('Tem certeza que deseja apagar toda a carteira?')){
      carteira = []; save(); render();
    }
  });

  // ===== Adicionar ativo =====
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const ticker = String(form.ticker.value).trim().toUpperCase();
    const tipo = form.tipo.value;
    const quantidade = Number(form.quantidade.value);
    const preco = parseBRL(form.preco.value);
    const corretagem = parseBRL(form.corretagem.value);

    if(!ticker || !quantidade || !preco) return;

    const investido = round2(quantidade * preco + corretagem);
    const precoMedio = round2(investido / quantidade);

    const existente = carteira.find(p => p.ticker === ticker && p.tipo === tipo);
    if (existente){
      // recalcula preço médio com novo lote
      const totalQtde = existente.quantidade + quantidade;
      const totalInv = existente.investido + investido;
      existente.quantidade = totalQtde;
      existente.investido = round2(totalInv);
      existente.precoMedio = round2(totalInv / totalQtde);
    } else {
      carteira.push({
        id: crypto.randomUUID(),
        ticker, tipo, quantidade,
        investido, precoMedio,
        precoAtual: 0
      });
    }
    save();
    form.reset();
    render();
  });

  // ===== Render =====
  function render(){
    corpo.innerHTML = '';
    let totalInv = 0, totalAtual = 0;

    carteira.forEach(pos => {
      const valorAtual = round2((pos.precoAtual || 0) * pos.quantidade);
      const resultado = round2(valorAtual - pos.investido);
      const perc = pos.investido ? ((resultado / pos.investido) * 100) : 0;
      totalInv += pos.investido;
      totalAtual += valorAtual;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap"><strong>${pos.ticker}</strong></td>
        <td><span class="pill">${pos.tipo}</span></td>
        <td class="right">${fmtNum.format(pos.quantidade)}</td>
        <td class="right">${toBRL(pos.precoMedio)}</td>
        <td class="right">${toBRL(pos.investido)}</td>
        <td class="right editable" data-id="${pos.id}">${pos.precoAtual ? toBRL(pos.precoAtual) : '<span class="muted">—</span>'}</td>
        <td class="right">${valorAtual ? toBRL(valorAtual) : '<span class="muted">—</span>'}</td>
        <td class="right ${resultado>=0?'green':'red'}">${resultado ? toBRL(resultado) : toBRL(0)}</td>
        <td class="right ${resultado>=0?'green':'red'}">${perc.toFixed(2)}%</td>
        <td class="right">
          <div class="actions" style="justify-content:flex-end">
            <button class="btn sec" data-edit="${pos.id}">Editar</button>
            <button class="btn danger" data-del="${pos.id}">Excluir</button>
          </div>
        </td>
      `;
      corpo.appendChild(tr);
    });

    sumInvestido.textContent = toBRL(totalInv);
    sumAtual.textContent = toBRL(totalAtual);
    const res = round2(totalAtual - totalInv);
    const perc = totalInv ? (res/totalInv)*100 : 0;
    sumResultado.innerHTML = `${res>=0?'<span class="green">'+toBRL(res)+'</span>':'<span class="red">'+toBRL(res)+'</span>'} <span class="muted">(${perc.toFixed(2)}%)</span>`;

    hookEvents();
  }

  function hookEvents(){
    // Editar registro (carrega no form)
    document.querySelectorAll('[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pos = carteira.find(p => p.id === btn.dataset.edit);
        if(!pos) return;
        form.ticker.value = pos.ticker;
        form.tipo.value = pos.tipo;
        form.quantidade.value = pos.quantidade;
        form.preco.value = pos.precoMedio.toString().replace('.', ',');
        form.corretagem.value = '0,00';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    // Excluir
    document.querySelectorAll('[data-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        if(!confirm('Excluir esta posição?')) return;
        carteira = carteira.filter(p => p.id !== btn.dataset.del);
        save(); render();
      });
    });

    // Duplo clique para editar Preço Atual
    document.querySelectorAll('td.editable').forEach(td => {
      td.addEventListener('dblclick', () => makeEditable(td));
    });
  }

  function makeEditable(td){
    const id = td.dataset.id;
    const pos = carteira.find(p => p.id === id);
    if(!pos) return;
    const old = pos.precoAtual ? pos.precoAtual.toString().replace('.', ',') : '';

    td.innerHTML = `<input id="_edit" style="width:110px; background:#0b1020; color:var(--text); padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.2)" placeholder="0,00" value="${old}">`;
    const input = td.querySelector('#_edit');
    input.focus();

    function commit(){
      const v = parseBRL(input.value);
      pos.precoAtual = round2(v);
      save(); render();
    }
    input.addEventListener('blur', commit);
    input.addEventListener('keydown', (ev) => {
      if(ev.key === 'Enter') commit();
      if(ev.key === 'Escape') render();
    });
  }

  // ===== CSV Export / Import =====
  function toCsv(){
    const headers = ['ticker','tipo','quantidade','precoMedio','investido','precoAtual'];
    const lines = [headers.join(';')].concat(
      carteira.map(p => [p.ticker,p.tipo,p.quantidade,p.precoMedio,p.investido,p.precoAtual].join(';'))
    );
    return lines.join('\n');
  }

  function downloadCsv(){
    const blob = new Blob(["\uFEFF" + toCsv()], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'carteira_b3.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function importCsv(text){
    const lines = text.trim().split(/\r?\n/);
    const header = lines.shift();
    const idx = header.split(';');
    const req = ['ticker','tipo','quantidade','precoMedio','investido','precoAtual'];
    const ok = req.every((h,i) => (idx[i]||'').toLowerCase() === h);
    if(!ok){ alert('Cabeçalho CSV inválido. Use o arquivo exportado pelo sistema.'); return; }

    carteira = lines.map(l => {
      const [ticker,tipo,qt,pm,inv,pa] = l.split(';');
      return {
        id: crypto.randomUUID(),
        ticker: ticker.toUpperCase(),
        tipo,
        quantidade: Number(qt),
        precoMedio: round2(parseFloat(pm)),
        investido: round2(parseFloat(inv)),
        precoAtual: round2(parseFloat(pa||'0'))
      };
    });
    save(); render();
  }

  document.getElementById('exportarCsv').addEventListener('click', downloadCsv);
  document.getElementById('importCsv').addEventListener('change', (e) => {
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => importCsv(reader.result);
    reader.readAsText(f, 'utf-8');
    e.target.value = '';
  });

  // ===== Inicialização =====
  render();
</script>
</body>
</html>
