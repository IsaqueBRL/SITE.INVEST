<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabela Edit√°vel</title>
  <style>
    :root{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0}
    body{padding:24px;background:#f6f8fb;color:#0f172a}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(14,20,30,0.06);padding:18px}
    h1{margin:0 0 14px;font-size:18px}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .controls > *{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
    .controls input[type="text"]{min-width:220px}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
    th{background:#fbfdff;position:sticky;top:0}
    tr:hover{background:#fbfcff}
    td[contenteditable]{min-width:80px}

    .small{font-size:13px;padding:6px 8px}
    .btn-primary{background:#0b69ff;color:#fff;border:none}
    .btn-danger{background:#ff5b5b;color:#fff;border:none}

    .right{margin-left:auto}
    .muted{color:#64748b;font-size:13px}
    .actions{display:flex;gap:6px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Tabela Edit√°vel ‚Äî Salve/Exporte/Importe</h1>
    <div class="controls">
      <button id="addRow" class="small">‚ûï Adicionar linha</button>
      <button id="delRow" class="small btn-danger">üóëÔ∏è Excluir selecionadas</button>
      <button id="exportCsv" class="small btn-primary">‚¨áÔ∏è Exportar CSV</button>
      <label style="display:inline-flex;align-items:center;gap:8px">
        <input id="importCsv" type="file" accept=".csv" style="display:none"/>
        <button id="importBtn" class="small">‚¨ÜÔ∏è Importar CSV</button>
      </label>
      <button id="saveLocal" class="small">üíæ Salvar local</button>
      <button id="loadLocal" class="small">üìÇ Carregar local</button>
      <input id="search" type="text" placeholder="Pesquisar..." />
      <div class="right muted">Clique duas vezes em uma c√©lula para editar.</div>
    </div>

    <div style="overflow:auto;max-height:60vh">
      <table id="table">
        <thead>
          <tr>
            <th style="width:36px"><input id="selectAll" type="checkbox" /></th>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Observa√ß√µes</th>
            <th style="width:120px">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <!-- linhas geradas via JS -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Dados iniciais de exemplo
    const initialData = [
      {nome:'Isaque Moises', email:'isaque@example.com', telefone:'(69) 9xxxx-xxxx', obs:'Cliente VIP'},
      {nome:'Maria Silva', email:'maria@example.com', telefone:'(69) 9yyyy-yyyy', obs:'Fornecedor'}
    ];

    const tbody = document.querySelector('#table tbody');
    const searchInput = document.getElementById('search');

    function render(data = []){
      tbody.innerHTML = '';
      data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.index = idx;

        tr.innerHTML = `
          <td><input class="rowSel" type="checkbox"/></td>
          <td contenteditable="true" data-key="nome">${escapeHtml(row.nome || '')}</td>
          <td contenteditable="true" data-key="email">${escapeHtml(row.email || '')}</td>
          <td contenteditable="true" data-key="telefone">${escapeHtml(row.telefone || '')}</td>
          <td contenteditable="true" data-key="obs">${escapeHtml(row.obs || '')}</td>
          <td class="actions">
            <button class="small" data-action="duplicate">Duplicar</button>
            <button class="small btn-danger" data-action="delete">Excluir</button>
          </td>`;

        tbody.appendChild(tr);
      });
    }

    // util
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // state
    let rows = JSON.parse(localStorage.getItem('tabela:rows')) || initialData.slice();
    render(rows);

    // eventos - delega√ß√£o
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const tr = e.target.closest('tr');
      const i = Number(tr.dataset.index);
      const action = btn.dataset.action;
      if(action === 'delete'){
        rows.splice(i,1);
        saveAndRender();
      }
      if(action === 'duplicate'){
        rows.splice(i+1,0, {...rows[i] });
        saveAndRender();
      }
    });

    // aplicar edi√ß√£o inline
    tbody.addEventListener('input', (e)=>{
      const td = e.target.closest('td[contenteditable]');
      if(!td) return;
      const key = td.dataset.key;
      const tr = td.closest('tr');
      const i = Number(tr.dataset.index);
      rows[i][key] = td.innerText.trim();
      // debounced save optional
    });

    // adicionar linha
    document.getElementById('addRow').addEventListener('click', ()=>{
      rows.push({nome:'',email:'',telefone:'',obs:''});
      saveAndRender();
      // focar na √∫ltima linha, primeira c√©lula
      requestAnimationFrame(()=>{
        const last = tbody.querySelector('tr:last-child td[contenteditable]');
        if(last) last.focus();
      });
    });

    // excluir selecionadas
    document.getElementById('delRow').addEventListener('click', ()=>{
      const sels = Array.from(tbody.querySelectorAll('.rowSel'));
      const toKeep = [];
      sels.forEach((chk, idx)=>{ if(!chk.checked) toKeep.push(rows[idx]); });
      rows = toKeep;
      saveAndRender();
    });

    // select all
    document.getElementById('selectAll').addEventListener('change', e=>{
      const checked = e.target.checked;
      tbody.querySelectorAll('.rowSel').forEach(c=>c.checked = checked);
    });

    // a√ß√µes salvar/carregar local
    document.getElementById('saveLocal').addEventListener('click', ()=>{
      localStorage.setItem('tabela:rows', JSON.stringify(rows));
      alert('Salvo no armazenamento local do navegador.');
    });
    document.getElementById('loadLocal').addEventListener('click', ()=>{
      const stored = localStorage.getItem('tabela:rows');
      if(stored) rows = JSON.parse(stored);
      saveAndRender();
      alert('Carregado do armazenamento local.');
    });

    // export CSV
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const csv = toCsv(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'tabela.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // import CSV
    const importInput = document.getElementById('importCsv');
    document.getElementById('importBtn').addEventListener('click', ()=> importInput.click());
    importInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const txt = await f.text();
      const parsed = csvToObjects(txt);
      if(parsed.length) rows = parsed;
      saveAndRender();
    });

    // pesquisar
    searchInput.addEventListener('input', ()=>{
      const q = searchInput.value.trim().toLowerCase();
      if(!q){ render(rows); return; }
      const filtered = rows.filter(r => Object.values(r).join(' ').toLowerCase().includes(q));
      render(filtered);
    });

    // helper: salvar estado e re-renderizar
    function saveAndRender(){
      // keep persistent copy in localstorage but do not auto-overwrite unless user saves explicitly
      render(rows);
    }

    // CSV helpers (simples)
    function toCsv(arr){
      const headers = ['nome','email','telefone','obs'];
      const esc = v => '"' + String(v||'').replace(/"/g,'""') + '"';
      const lines = [headers.join(',')];
      arr.forEach(r => { lines.push([r.nome,r.email,r.telefone,r.obs].map(esc).join(',')); });
      return lines.join('\n');
    }
    function csvToObjects(txt){
      const rows = txt.split(/\r?\n/).filter(Boolean);
      if(rows.length === 0) return [];
      const headers = rows[0].split(',').map(h=>h.replace(/(^\s+|\s+$|\"|\')/g,''));
      const out = [];
      for(let i=1;i<rows.length;i++){
        const cols = parseCsvLine(rows[i]);
        const obj = {};
        headers.forEach((h,idx)=> obj[h.trim()] = cols[idx] || '');
        out.push({nome: obj.nome||'', email: obj.email||'', telefone: obj.telefone||'', obs: obj.obs||''});
      }
      return out;
    }
    function parseCsvLine(line){
      const result = [];
      let cur = '', inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"') { inQuotes = !inQuotes; continue; }
        if(ch === ',' && !inQuotes){ result.push(cur); cur = ''; continue; }
        cur += ch;
      }
      result.push(cur);
      return result.map(s=>s.trim());
    }

    // initialize
    saveAndRender();
  </script>
</body>
</html>
